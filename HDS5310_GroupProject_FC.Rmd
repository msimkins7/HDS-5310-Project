```{r}
require(SASxport)
```

```{r}
library(foreign)
```
```{r}
install.packages('dplyr')
library('tidyverse')
```

```{r}
DEMO_I <- read.xport ("DEMO_I.xpt")
HIQ_I <- read.xport ("HIQ_I.xpt")
HOQ_I <- read.xport ("HOQ_I.xpt")
INQ_I <- read.xport ("INQ_I.xpt")
PAQ_I <- read.xport ("PAQ_I.xpt")
```


```{r}
#merge datasets together
nhanes_1 <- full_join (DEMO_I, HIQ_I, by = "SEQN")
```

```{r}
nhanes_2 <-full_join(nhanes_1, HOQ_I, by = "SEQN")
```

```{r}
nhanes_3 <- full_join (nhanes_2, INQ_I, by = "SEQN")
```

```{r}
nhanes_final <- full_join(nhanes_3, PAQ_I, by = "SEQN")
```

```{r}
#create a small data set with selected variables: sex, age, education, income, housing, insurance, mins of mPA
nhanes_small<-nhanes_final%>%
  select(RIAGENDR, RIDAGEYR,RIDRETH3, DMDEDUC2,DMDEDUC3,INDFMIN2, HOQ065,HIQ011, PAD675)
```

```{r}
#view data
summary(nhanes_small)
```

```{r}
nhanes_recoded<-nhanes_small%>%
  mutate(RIAGENDR = recode_factor(.x=RIAGENDR,
                                    `1`='Male',
                                    `2` = 'Female'))%>%
mutate(RIDRETH3 = recode_factor(.x=RIDRETH3,
                                `1`= 'Hispanic',
                                `2`= 'Hispanic',
                                `3` = 'None-Hispanic White',
                                `4` = 'None-Hispanice Black',
                                `6` = 'Non-Hispanic Asian',
                                `7` = 'Other Race-Including Multi-racial'))%>%
mutate(DMDEDUC2 = recode_factor(.x=DMDEDUC2,
                                `1` = 'Less than 9th grade',
                                `2`='9-11th grade (Includes 12th grade with no diploma)', 
                                `3`='High school graduate/GED or equivalent', 
                                `4`= 'Some college or AA degree',
                                `5`= 'College graduate or above',
                                `7`= NA_character_,  
                                `9`= NA_character_))%>%
mutate(DMDEDUC3 = recode_factor(.x=DMDEDUC3,
                                `0`= 'Never attended school', 
                                `1`= 'Less than 9th grade',
                                `2`= 'Less than 9th grade',
                                `3`= 'Less than 9th grade',
                                `4`= 'Less than 9th grade',
                                `5`= 'Less than 9th grade',
                                `6`= 'Less than 9th grade',
                                `7`= 'Less than 9th grade',
                                `8`= 'Less than 9th grade',
                                `9`= '9-11th grade (Includes 12th grade with no diploma)',
                                `10`= '9-11th grade (Includes 12th grade with no diploma)',
                                `11`= '9-11th grade (Includes 12th grade with no diploma)',
                                `12`= '9-11th grade (Includes 12th grade with no diploma)',
                                `13`= 'High school graduate/GED or equivalent',
                                `14`= 'High school graduate/GED or equivalent',
                                `15`= 'High school graduate/GED or equivalent',
                                `55`= 'Less than 9th grade',
                                `66`= 'Less than 9th grade',
                                `77`= NA_character_, 
                                `99`= NA_character_))%>%
  mutate(age_group = case_when(RIDAGEYR <6 ~ NA_character_,
   RIDAGEYR >=6 & RIDAGEYR <18 ~ '6-17',
  RIDAGEYR >=18 & RIDAGEYR <=59 ~ '18-59',
   RIDAGEYR >=60 & RIDAGEYR <=74 ~ '60-74',
  RIDAGEYR >=75 ~ '75+'
                                ))%>%
mutate(INDFMIN2=recode_factor(.x=INDFMIN2,
                                `1` = '<$20,000',
                                `2` = '<$20,000',
                                `3` = '<$20,000',
                                `4` = '<$20,000',
                                `5`= '$20,000-$99,999',
                                `6` = '$20,000-$99,999',
                                `7` ='$20,000-$99,999',
                                `8` ='$20,000-$99,999',
                                `9` ='$20,000-$99,999',
                                `10` = '$20,000-$99,999',
                                `12` = '$20,000-$99,999',
                                `13` = '<$20,000',
                                `14` = '$20,000-$99,999',
                                `15` = '$100,000 +',
                                `77` = NA_character_,
                                `99` =NA_character_ ))%>%
mutate(HOQ065 = recode_factor(.x=HOQ065,
                              `1` = 'Owned or bought',
                              `2` = 'Rented',
                              `3` = 'Other arrangement',
                              `7`= NA_character_,  
                              `9`= NA_character_))%>%
mutate(HIQ011 = recode_factor(.x =HIQ011,
                              `1` = 'Yes',
                              `2` = 'No',
                              `7`= NA_character_,  
                              `9`= NA_character_))%>%
mutate(PAD675= na_if(x=PAD675, y=9999))%>%
mutate(PAD675= na_if(x=PAD675, y=7777))%>% 
rename(sex = RIAGENDR) %>%
rename(race.eth = RIDRETH3) %>%
rename(adult.ed = DMDEDUC2) %>%
rename(child.ed = DMDEDUC3) %>%
rename(home.owned = HOQ065) %>%
rename(health.ins = HIQ011) %>%
rename(fam.annual.income = INDFMIN2)%>%
rename(age = RIDAGEYR)%>%
rename(mPA = PAD675)
```

```{r}
summary(nhanes_recoded)
```
#mPA by Health Insurance Status

  #Data Visualization:

  boxplot.health.ins <- nhanes_recoded %>%
    drop_na (health.ins) %>%
    ggplot (aes(y = mPA)) +
    geom_boxplot()+
    facet_grid(cols = vars(health.ins)) +
    theme_minimal () +
    labs (y = "Minutes of Physcial Activity Daily") +
    coord_flip()

  boxplot.health.ins
  
```
  

```{r}
  #Independent Samples T-test NHST:

    #NHST Step 1: Writing the null and alternative hypotheses 
      #H0: There is no difference in the mean minutes of physical activity between health insurance status groups.
      #HA: There is a difference in the mean minutes of physical activity between health insurance status groups.

    #NHST Step 2 and 3: Determining the test statistic and calculating the probability that the test statistic is at least as big as it is if there is no relationship

twosampt <- t.test(formula = nhanes_recoded$mPA ~
               nhanes_recoded$health.ins)

twosampt
  
    #NHST Step 4 and 5: Interpret the probability and write a conclusion.

      #The Independent Samples T-test produced a statistically significant result (t(502.36) = -4.9336; p-value < .05). Therefore, there is a statistically                             significant difference in the mean minutes of daily physical activity between those with health insurance, or those that answered "yes," (m = 60.77) and those without           health insurance, or those that answered "no" (m = 77.20) in the sample. Given the sample used to create the NHANES 2015-2016 data set  was composed of members of the U.S       Population, it can be concluded that those with health insurance in the U.S likely have a different mean number of minutes of daily physical activity than those without         health insurance in the U.S. The difference between mean number of minutes of daily physical activity in those with health insurance and those without health insurance           was -16.43 minutes. In the U.S population this sample came from, the difference was likely between -22.97 and -9.88 minutes (95% CI: -22.97 - -9.88). 

```

```{r}

#Checking Independent Samples T-test Assumptions:

#1.) Independent Observations -- met. We feel this assumption is met for NHANES 2015-2016 Participants are from separate households, and therefore, likely independent of one    another.

 #2.) Normality -- not met. When looking at the histograms for both distributions ("yes" health insurance status and mPA and "no" health insurance status and mPA), neither appears normally distributed.

# Creating Histogram of mPA by Health Insurance Status 
nhanes_recoded %>%
      drop_na (health.ins) %>%
      ggplot(aes(x = mPA)) +
      geom_histogram(fill = "black", col = "white") +
      facet_grid(cols = vars(health.ins)) +
      theme_minimal() +
      labs(x="Minutes of Physical Activity Daily",
      y ="NHANES Participants")


#3.) Equal Variances/Homoscedasity -- not determined. Given that a Welch's Independent Samples T-test was run, it is not necessary to determine if the equal variances/homoscedasity assumption is met as would be necessary for a Student's Independent Samples T-test.

#The normality assumption is not met for the Independent Samples T-test, therefore, a Mann-Whitney U Test must be performed.

```

```{r}

#Mann-Whitney U Test NHST

    #NHST Step 1: Writing the null and alternative hypotheses 
      #H0: There is no difference in the mean minutes of physical activity between health insurance       status groups.
      #HA: There is a difference in the mean minutes of physical activity between health insurance        status groups.

    #NHST Step 2 and 3: Determining the test statistic and calculating the probability that the         test statistic is at least as big as it is if there is no relationship

    mann.whitney <- wilcox.test (formula = nhanes_recoded$mPA ~ 
                                   nhanes_recoded$health.ins,
                                   paired = FALSE)
    mann.whitney
    
   #[Determining r for Mann-Whitney U Test]
    
  
nhanes_recoded.noNA <- nhanes_recoded %>%
    drop_na(mPA)

rcompanion::wilcoxonR(x = nhanes_recoded.noNA$mPA,
          g = nhanes_recoded.noNA$health.ins)

    #NHST Step 4 and 5: Interpret the probability and write a conclusion.

      #The Mann-Whitney U Test produced a statistically significant result (W = 431651, p-value < .05). Therefore, it can be concluded that there is a statistically significant       difference in mean number of minutes of physical activity daily between those with health insurance, or  those that answered "yes", and those without health insurance, or       those that answered "no". The effect size .0983 (rounded to .1) was small indicating a weak but statistically significant relationship between health insurance status and       number of minutes of daily physical activity.
    
    
```

